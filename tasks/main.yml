---
- name: apt-transport-https present
  apt:
    pkg:
      - apt-transport-https
    state: present
  tags:
    - nodejs

- name: Nodesource GPG key present
  apt_key:
    id: 9FD3B784BC1C6FC31A8A0A1C1655A0AB68576280
    url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
    state: present
  tags:
    - nodejs

- name: Nodesource APT repo available
  template:
    src: templates/nodejs.list.j2
    dest: /etc/apt/sources.list.d/nodejs.list
  tags:
    - nodejs

- name: Remove node in /usr/local/bin
  file:
    path: /usr/local/bin/node
    state: absent
  tags:
    - nodejs

- name: Check if nodejs is already installed
  command: which nodejs
  check_mode: false
  register: nodejs_path_check
  failed_when: nodejs_path_check.rc is not regex('0|1')
  tags:
    - nodejs

- name: Check version of nodejs
  block:

    - name: Version of nodejs installed
      command: nodejs --version
      check_mode: false
      register: nodejs_installed_check
      changed_when: false

    - name: Set a variable for the installed version of Node
      set_fact:
        nodejs_installed: "{{ nodejs_installed_check.stdout | replace('v', '') | regex_replace('\\.(.*)$') | trim }}"

    - name: Print the installed and required versions
      debug:
        msg: "nodejs installed is {{ nodejs_installed }} and required is {{ nodejs_version }}"
        verbosity: 1

    - name: Remove nodejs if the installed version is newer than the required version
      apt:
        pkg:
          - nodejs
        state: absent
      when: nodejs_installed | int > nodejs_version | int

  when: nodejs_path_check.rc == 0
  tags:
    - nodejs

- name: Nodejs package present
  apt:
    pkg:
      - nodejs
    state: latest
    update_cache: true
  tags:
    - nodejs

- name: Install additional node.js packages
  npm:
    name: sass
    global: true
  loop: "{{ nodejs_packages }}"
  loop_control:
    loop_var: pkg
  when: ( nodejs_packages is defined ) and ( nodejs_packages != [] )
  tags:
    - nodejs
...

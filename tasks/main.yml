---
- name: Install and upgrade Node.js
  block:

    - name: Variables checked
      assert:
        that:
          - nodejs_install is regex('^binary|nodesource')

    - name: Binary install variables checked
      assert:
        that: >
          ( nodejs_version == "latest" ) or
          ( nodejs_version is regex ('^latest-v[0-9]{1,2}[.]x$') ) or
          ( nodejs_version is regex ('^[0-9]{1,2}[.][0-9]{1,2}[.][0-9]{1,2}$') )
      when: nodejs_install == "binary"

    - name: Nodesource install variables checked
      assert:
        that:
          - nodejs_version | type_debug == "int"
          - nodejs_version is regex ('^[0-9]{2}$')
      when: nodejs_install == "nodesource"

    - name: Include local fact tasks if variables are not defined
      ansible.builtin.include_tasks: local_facts.yml
      when: >
        ( ansible_local.dpkg.arch is not defined ) or
        ( ansible_local.gpg.version is not defined ) or
        ( ansible_local.bash.path is not defined )
      tags:
        - nodejs_apt_local_facts

    - name: Include Node.js nodesource install tasks
      ansible.builtin.include_tasks: nodesource.yml
      when: nodejs_install == "nodesource"

    - name: Include Node.js binary install tasks
      ansible.builtin.include_tasks: binary.yml
      when: nodejs_install == "binary"

  when: nodejs | bool
  tags:
    - nodejs
...

---
- name: apt-transport-https and lsb-release packages present
  apt:
    pkg:
      - apt-transport-https
      - lsb-release
    state: present
    update_cache: false
  tags:
    - nodejs

- name: Check the distro version using lsb_release
  shell: "lsb_release -c | awk '{ print $2 }'"
  register: nodejs_distro_check
  changed_when: false
  check_mode: false
  tags:
    - nodejs

- name: Set nodejs_distro variable
  set_fact:
    nodejs_distro: "{{ nodejs_distro_check.stdout }}"
  tags:
    - nodejs

- name: Nodesource GPG key present
  apt_key:
    id: 9FD3B784BC1C6FC31A8A0A1C1655A0AB68576280
    url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
    state: present
  tags:
    - nodejs

- name: Nodesource APT repo available
  template:
    src: templates/nodejs.list.j2
    dest: /etc/apt/sources.list.d/nodejs.list
  tags:
    - nodejs

- name: Check if nodejs is already installed
  shell: which nodejs || echo absent
  check_mode: false
  register: nodejs_path_check
  changed_when: '"nodejs" not in nodejs_path_check.stdout'
  tags:
    - nodejs

- name: Check version of nodejs
  block:

    - name: Version of nodejs installed
      command: nodejs --version
      check_mode: false
      register: nodejs_installed_check
      changed_when: false
      tags:
        - nodejs

    - name: Set a variable for the installed version of Node
      set_fact:
        nodejs_installed: "{{ nodejs_installed_check.stdout | replace('v', '') | trim | int }}"
      tags:
        - nodejs
   
    - name: Remove nodejs if the installed version is newer than the required version
      apt:
        pkg:
          - nodejs
        state: absent
      when: nodejs_installed | int > nodejs_version | int 
      tags:
        - nodejs

  when: ( nodejs_path_check is defined ) and ( "nodejs" in nodejs_path_check.stdout )

- name: Nodejs package present
  apt:
    pkg:
      - nodejs
    state: present
    update_cache: true
  tags:
    - nodejs
...
